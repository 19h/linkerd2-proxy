#!/bin/sh

set -eux

(cd linkerd2-proxy && cargo build --release --features=mock-orig-dst)

export LINKERD2_PROXY_LOG="off"
export LINKERD2_PROXY_INBOUND_ORIG_DST_ADDRS="127.0.0.1:7000"
export LINKERD2_PROXY_OUTBOUND_ORIG_DST_ADDRS="127.0.0.1:7001,127.0.0.1:7002,127.0.0.1:7003,127.0.0.1:7004,127.0.0.1:7005,127.0.0.1:7006,127.0.0.1:7007,127.0.0.1:7008,127.0.0.1:7009,127.0.0.1:7010,127.0.0.1:7011,127.0.0.1:7012,127.0.0.1:7013,127.0.0.1:7014,127.0.0.1:7015,127.0.0.1:7016,127.0.0.1:7017,127.0.0.1:7018,127.0.0.1:7019,127.0.0.1:7020,127.0.0.1:7021,127.0.0.1:7022,127.0.0.1:7023,127.0.0.1:7024,127.0.0.1:7025,127.0.0.1:7026,127.0.0.1:7027,127.0.0.1:7028,127.0.0.1:7029,127.0.0.1:7030"
export LINKERD2_PROXY_DESTINATION_SVC_ADDR="127.0.0.1:6999"
export LINKERD2_PROXY_DESTINATION_PROFILE_SUFFIXES="example.com"
export LINKERD2_PROXY_DESTINATION_PROFILE_NETWORKS="127.0.0.1/32"
export LINKERD2_PROXY_TAP_DISABLED=1
export LINKERD2_PROXY_IDENTITY_DISABLED=1
export LINKERD2_PROXY_CPUS=5

heaptrack target/release/linkerd2-proxy
